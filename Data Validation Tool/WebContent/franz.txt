<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Compose</title>
    <script type="text/javascript" src="<?php echo base_url();?>/js/jquery.js"></script>
    <script>
        $(document).ready(function(){
            $("#sub").attr("disabled", "disabled");
            $('#username').keyup(username_check);
    
        });
	
        function username_check(){	
            var username = $('#username').val();
            if(username == ""){
                $('#username'). css('border', '3px #CCC solid');
                $('#tick').hide();
            }
            else{

                jQuery.ajax({
                    type: "POST",
                    url: "check",
                    data: 'username='+ username,
                    cache: false,
                    success: function(response){
                        if(response <= 0){
	                       $('#username').css('border', '3px #C33 solid');	
	                       $('#tick').hide();
	                       $('#cross').fadeIn();
                           $("#sub").attr("disabled", "disabled");
                        }
                        else{
	                       $('#username').css('border', '3px #090 solid');
                           $('#cross').hide();
                           $('#tick').fadeIn();
                           $('#sub').removeAttr("disabled");
                        }

                     }
                });
            }

        }

    </script>

    <style>
        #username,#subject,#msg{
	       padding:3px;
	       font-size:18px;
	       border:3px #CCC solid;
        }

        #tick{display:none}
        #cross{display:none}
    </style>
    
</head>

<body>
    <?php echo form_open('PostNotificationsController/sendMail');?>
        <h1>Send Message</h1>
        <table id="mailBody">
            <tr>
                <td><p>To:</p></td>
                <td>
                  <input name="username" id="username" type="text" size="23"/>
                  <img id="tick" src="<?php echo base_url();?>/img/tick.png" width="16" height="16"/>
                  <img id="cross" src="<?php echo base_url();?>/img/cross.png" width="16" height="16"/>
                </td>
            </tr>
            <tr>
                <td><p>Subject:</p></td>
                <td>
                    
                    <input name="subject" id="subject" type="text" size="23"/>
                </td>
            </tr>
            <tr>
                <td></td>
                <td><textarea name="msg" id="msg" cols="19" rows="10"></textarea></td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <input type="submit" name="sub" id="sub" value="Send"/>
                    <input type="reset" value="Reset"/>
                </td>
                
            </tr>
        </table>
    </form>
    
    <?php echo anchor('PostNotificationsController/','Return');?>
</body>
</html>

==============================================================================================
<?php

class PostNotificationsController extends Controller{

    function PostNotificationsController(){
		parent::Controller();
		$this->load->helper('url');
		$this->load->helper('form');
        $this->load->model('Notifications_model', '', TRUE);
        session_start();	 
	}
    
    function index(){
        $this->load->view('notifications/messagecenter_view');
    }
    
    function requestInbox(){
        $data['messgs'] = $this->Notifications_model->retrieveNotices($_SESSION['user']);
        $result = $this->load->view('notifications/inbox_view',$data,true);
        echo $result;
        
    }
    function getMsg(){
        $id = $_POST['id'];
        $this->db->select('*');
        $this->db->from('notifications');
        $this->db->where('id',$id);
        $query = $this->db->get();
        
        //echo $query;
        $arr = $query->_fetch_assoc();
        
        echo "<h2>".$arr['subject']."</h2>";
        echo "<p>From: ".$arr['sender']."</p>";
        echo "<p>To: ".$arr['receiver']."</p>";
        echo "<p>".$arr['message']."</p>";
    }
    
    function requestTrash(){
        
    }
    
    function requestCompose(){
        $this->load->view('notifications/compose_view');
    }
    
    function sendMail(){
        $to = $_POST['username'];
        $from = $_SESSION['user'];
        $subject = $_POST['subject'];
        $msg = $_POST['msg'];
        
        $status = $this->Notifications_model->sendNotice($to,$from,$subject,$msg);
        redirect('PostNotificationsController/');
    }
    
    function check(){
        $username = trim(strtolower($_POST['username']));
        //$username = mysql_escape_string($username);

        $this->db->select('username');
        $this->db->from('user');
        $this->db->where('username',$username);
        $query = $this->db->get();
        
        echo $query->num_rows();
    }
}
?>